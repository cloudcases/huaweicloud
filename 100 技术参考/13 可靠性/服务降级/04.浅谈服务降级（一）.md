# 浅谈服务降级（一）

[家园叮咚](https://www.modb.pro/u/446854)2020-10-01

**1** **引子**

同学们有没有过这样的经历：

​    商城或web站点的用户访问量出乎意料地增加了很多，超出了系统的负载能力， 系统有些扛不住，继而导致注册，下单，支付什么的全部在绕圈卡住，继而导致公司业务损失了不少用户和订单。同学们可能会说，临时购买和安装服务器，增加服务器解决此类问题，但是大家知道，这个操作是比较耗时的，不能用来十分及时地解决紧急突发问题。

上面这种情况在高流量站点中，并不是偶然事件，是时常会发生的。

面对一大波访问量出乎意料地涌入，超出了系统正常的负载范围，我们可以采用降级来应对，何谓降级？就是将不重要的服务和功能采用屏蔽，或降低实时性，或延迟处理，等等方式，最终目的是保证核心服务可用。在这里，我们引入降级。

**2** **什么是降级****,** **为什么降级，降级的场景。**

降级的最终目的是保证核心服务的高可用。过程就是丢卒保帅，有些服务是无法降级的，比如支付。

当我们的服务器压力剧增为了**保证核心功能的可用性** ，而**选择性的降低一些功能的可用性，或者直接关闭该功能**。这就是典型的**丢车保帅**了。就比如贴吧类型的网站，当服务器吃不消的时候，可以选择把发帖功能关闭，注册功能关闭，改密码，改头像这些都关了，为了确保登录和浏览帖子这种核心的功能。

**降级的原理**：就是降低次要功能的可用性实用性，增加核心功能的高可用性。

降级的实现原理是多样多样的。

我们**的降级实现过程原理**：利用一个降级开关，以这个开关为判断依据，切换数据的获取方式，比如当mysql负载高的时候，可以从mysql切换到redis，比如从redis切换到静态文件，比如从错误频发的新版本切换到老版本等等。这个开关是根据现状来配置的，比如当新版本错误频发的时候，我们可以配置这个开关为从老版本获取数据。

**3** **降级的种类**

**3.1** **根据降级的开关位置：分为服务代码降级和开关前置降级。**

代码降级就是利用代码控制，这种方式比前置降级要low并不推荐

前置降级是把降级开关放到http请求链路层的上游，降低链路层消耗。比如提升到nginx，甚至可以提升到前端，当提升到前端，后端访问压力接近于0

拓展：【如何提升到前端】

可以通过一个从服务器获取的js脚本进行控制。

**3.2** **根据读写：分为读降级和写降级。**

读降级，比如，读取动态数据，降级为读取静态数据。

写降级，比如，写入mysql，降级为写入消息队列， 等高峰期过后，在从队列写入mysql。

**3.3** **根据降级的性质：分为返回内容降级，限流降级，限速降级**

返回内容降级，比如，返回实时数据，降级为返回兜底数据

限流降级，比如，1000个请求，我只接受500个。这么做也是无奈之下选择，要不然系统崩了 谁都访问不了

限速降级，比如，对于那些访问过于频繁的ip进行限速

拓展：【限流限速】

nginx 自带限流限速，比如ngx_http_limit_req_module和ngx_http_limit_conn_module 。

但是这类模块只是提供了在nginx配置文件中进行简单的参数配置。

如果想更加灵活和功能更多，可以编写自己的lua代码进行控制，而不是用现成的模块进行配置文件修改。

**3.4** **根据降级的维护特点：分为手动降级和自动降级。**

手动降级，是人为看到系统负载异常后，手动调整降级

自动降级，是系统监测到异常后，自动降级，自动降级虽然更加智能，但有时候自动脚本可能会干一些超乎预料的事情

我们主要是要实现：采用nginx+lua+redis对广告推荐模块实现前置降级，读降级，内容降级，手动降级（附自动降级）。

**4** **业务分析**

广告推荐模块业务如下：

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20211022_e4a17f76-333f-11ec-9b11-fa163eb4f6be.png)



大家知道，广告推荐模块的特点：

1 是要经过对数据模型进行大量分析，并结合用户刚刚的浏览记录，计算出用户喜欢喜欢什么商品，然后给他打什么广告，运算量相当大。

2 是广告推荐模块不是商城的核心模块，没有了这个模块， 买家照样可以完成商品的购买。

  总结上面两点， 我们可以在商城负载过高时，对广告推荐模块进行降级，让它只从缓存或静态文件中读取数据，或者干脆nginx不返回任何数据给它。

**5** **设计分析**

需要降级的接口有很多，一般是和产品以及市场一起确定的，依据功能的重要程度， 不重要的功能就可以为它配置降级，我们这里**挑选广告推荐进行实战**

广告推荐模块分析：



如图，5种获取广告推荐数据的方式，从上而下，对系统带来的性能的损耗逐渐降低，最底下的第5种，几乎对系统没有损耗，但是数据实时性也是自上而下逐渐降低的，从需求上讲，我们更喜欢实时从数据库读取，但为了降低性能损耗，在系统负载重的时候， 我们可能不得不降级为从文件或者从缓存中读取。这个降级是通过一个开关可以控制的

**6** **降级的线路图**

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20211022_e523c40e-333f-11ec-9b11-fa163eb4f6be.png)

**详解：**

1 降级配置中心， 用于统一管理所有的微服务的降级开关， 该中心是单独的服务器，和微服务服务器集群是分开的

2 每个微服务都有一个降级开关。

开关前置：

![img](https://oss-emcsprod-public.modb.pro/wechatSpider/modb_20211022_e5593512-333f-11ec-9b11-fa163eb4f6be.png)

这个降级开关是个什么东西，结构如何呢？

实际上是一条条的redis数据， 每条数据就是一个开关。

这条开关数据的结构是这么设计的：

key：url链接中的请求地址。

value：记录这个请求从哪里读取数据，也就是配置从哪里查询数据。



https://www.modb.pro/db/144872