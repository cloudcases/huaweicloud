# 多租户解决方案要考虑的租户模型

- 项目
- 2022/03/20

可以通过许多不同的方法将解决方案设计为多租户解决方案。 此决策主要取决于是否在租户之间共享资源以及如何共享资源。 直观地，你可能希望避免共享任何资源，但随着业务规模和载入越来越多的租户，这很快就会变得昂贵。

通过首先了解如何为特定组织定义租户、拥有哪些业务驱动因素以及计划如何缩放解决方案，考虑多租户的不同模型会很有帮助。 在此页上，我们为技术决策者提供有关可以考虑的租户模型及其权衡的指导。

## 定义租户

首先，需要为 *组织定义* 租户。 考虑你的客户是谁。 换句话说，你要向谁提供服务？ 有两种常见模型：

- **企业到企业 (B2B)** 。 如果你的客户是其他组织，你很可能会将你的租户作为这些客户。 但是，请考虑你的客户是否可能 (团队或) 部门，或者他们是否在多个国家/地区存在。 如果这些子组有不同的要求，可能需要考虑将单个客户映射到多个租户。 同样，客户可能想要维护你的服务的两个实例，以便他们可以保持其开发和生产环境彼此隔离。 通常，单个租户将有多个用户。 例如，客户的所有员工都是同一租户中的用户。
- **企业到使用者 (B2C)** 。 如果客户是使用者，则关联客户、租户和用户通常更复杂。 在某些情况下，每个使用者可以是其自己的租户。 但是，请考虑你的解决方案是否可能由家庭、朋友组、社会成员、关联或其他可能需要一起访问和管理其数据的分组使用。 例如，音乐流式处理服务可能同时支持单个用户和系列，并且当涉及到将每个帐户类型分隔到租户中时，它可能会以不同方式处理这些帐户类型。

在 *构建解决方案* 时，租户的定义会影响需要考虑或强调的一些内容。 例如，请考虑以下不同类型的租户：

- 如果你的租户是个人或家庭，你可能需要特别关心如何处理个人数据，以及你服务的每个地区内的数据主权法律。
- 如果租户是企业，可能需要注意客户对法规合规性、其数据隔离的要求，并确保满足指定的服务级别目标 (SLO) ，例如运行时间或服务可用性。

## 如何决定使用哪个模型？

选择租户模型不仅仅是一项技术决策;这也是需要做出的商业决策。 需要考虑以下问题：

- 你的业务目标是什么？
- 你的客户是否接受所有形式的多租户？ 每个多租户模型如何影响合规性要求或客户的合规性要求？
- 单租户解决方案会缩放到未来的增长期望吗？
- 运营团队规模如何，以及能够自动执行多少基础结构管理？
- 你的客户是否期望你满足 SLA (协议) ，或者你是否具有你的目标 S SLA？

如果你预计你的业务将扩展为大量客户，则部署共享基础结构将非常重要。 否则，必须维护一个不断增大的大型实例群。 除非预配并使用每个租户的专用订阅，否则为每位客户部署单个 Azure 资源可能很成功。 在多个租户之间共享同一 Azure 订阅时， [Azure](https://docs.microsoft.com/zh-CN/azure/azure-resource-manager/management/azure-subscription-service-limits) 资源配额和限制可能会开始应用，并且部署和重新配置这些资源的运营成本会随着每个客户的增加而增加。

相反，如果你期望你的业务只拥有几个客户，则可能值得考虑使用专用于每个客户的单租户资源。 同样，如果客户的隔离要求很高，则单租户基础结构可能很合适。

## 逻辑租户和物理租户

接下来，需要确定租户对特定解决方案的含义，以及是否应该 *区分逻辑租户* 和 *物理* 租户。

例如，考虑使用音乐流式处理服务。 最初，你可以构建一个解决方案，该解决方案可以轻松处理成千上 (甚至数万) 用户。 但是，随着你不断发展，你可能会发现需要复制解决方案或它的一些组件，以便根据新的客户需求进行缩放。 这意味着，需要了解如何将特定客户分配到解决方案的特定实例。 可以随机、地理或填充单个实例，然后溢出到另一个实例来这样做。 但是，你可能需要保留你拥有哪些客户以及其数据和应用程序可用的基础结构的记录，以便可以将他们的流量路由到正确的基础结构。 此示例中，你可以将每个用户表示为单独的逻辑租户，然后将用户映射到表示已部署的不同实例的物理租户。 逻辑租户和物理租户之间具有一对多映射，并且可以自行在物理租户之间移动逻辑租户。

相反，假设有一家公司为法定公司构建云软件。 你的客户可能希望使用自己的专用基础结构来维护其符合性标准。 因此，需要准备好从一开始部署和管理解决方案的许多不同实例。 本示例中，逻辑租户和物理租户是相同的。

逻辑租户和物理租户之间的主要区别在于如何强制实施隔离。 当多个逻辑租户共享一组基础结构时，通常依赖于应用程序代码和数据库中的租户标识符，使每个租户的数据保持独立。 当你有物理租户时，它们有自己的基础结构，因此，对于代码来说，了解它在多租户环境中运行可能不太重要。

有时，你会看到称为部署、*超级*租户或标记的物理*租户*。 本文档的其余部分使用术语"部署"和"物理部署"，以避免逻辑租户和物理租户之间的混淆。

收到特定逻辑租户的请求时，需要将请求映射到保存该租户数据的物理部署，如下所示：

![Diagram showing the mapping between logical and physical tenants. A tenant mapping layer refers to a table that stores the relationship between logical tenants and physical deployments.](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/map-logical-physical.png)

## 租户隔离

设计多租户体系结构时，最大的考虑因素之一是每个租户所需的隔离级别。 隔离可能意味着不同的事物：

- 具有一组共享基础结构，具有单独的应用程序实例和每个租户的单独数据库。
- 共享一些常用资源，同时将其他资源与每个租户分开。
- 将数据保留于单独的物理基础结构上。 在云中，这可能要求每个租户使用单独的 Azure 资源，甚至意味着使用专用主机实际部署单独的 [物理基础结构](https://docs.microsoft.com/zh-CN/azure/virtual-machines/dedicated-hosts)。

不应将隔离视为离散属性，而应将隔离视为连续属性。 可以部署与同一体系结构中其他组件隔离程度或更少隔离的体系结构组件，具体取决于你的要求。 下图演示了连续的隔离：

![Diagram showing a continuum of isolation, ranging from fully isolated (shared nothing) to fully shared (shared everything).](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/isolated-shared.png)

隔离级别会影响体系结构的许多方面，包括：

- **安全性。** 如果在多个租户之间共享基础结构，则需要特别小心，在将响应返回给另一个租户时不要访问来自一个租户的数据。 你需要为标识策略提供强大的基础，并且需要在授权过程中同时考虑租户和用户标识。
- **成本。** 共享基础结构可用于多个租户，因此成本更便宜。
- **性能。** 如果共享基础结构，系统的性能可能会随着更多客户使用它而受到影响，因为资源消耗可能会更快。
- **可靠性。** 如果使用的是一组共享基础结构，则一个租户的组件出现问题可能会导致所有人中断。
- **响应各个租户的需求。** 部署专用于一个租户的基础结构时，你或许能够针对该特定租户的要求优化资源的配置。 甚至可以在定价模型中考虑这一点，使客户能够为独立部署支付更多费用。

解决方案体系结构可能会影响可用于隔离的选项。 例如，让我们考虑一个示例三层解决方案体系结构：

- 用户界面层可能是共享的多租户 Web 应用，所有租户都访问单个主机名。
- 中间层可以是具有共享消息队列的共享应用程序层。
- 数据层可以是独立数据库、表或 Blob 容器。

可以考虑在每个层混合和匹配不同级别的隔离。 有关共享内容以及隔离内容的决策将基于许多注意事项，包括成本、复杂性、客户要求，以及可在达到 Azure 配额和限制之前部署的资源数。

## 常见租户模型

确定要求后，请根据一些常见的租户模型和模式对其进行评估。

### 自动单租户部署

在自动化的单租户部署模型中，将针对每个租户部署一组专用基础结构，如以下示例所示：

![Diagram showing three tenants, each with separate deployments.](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/automated-single-tenant-deployments.png)

应用程序负责启动和协调每个租户资源的部署。 通常，使用此模型构建的解决方案在 Ia) C 或 Azure 资源管理器 API 中广泛使用基础结构 (代码。 需要为每个客户预配完全不同的基础结构时，可以使用此方法。 规划部署时，请考虑 [部署戳记模式](https://docs.microsoft.com/zh-cn/azure/architecture/patterns/deployment-stamp) 。

**优势：** 此方法的主要优点是，每个租户的数据都是隔离的，这将降低意外泄露的风险。 这对于具有高法规遵从性开销的某些客户来说很重要。 另外，租户不太可能影响彼此的系统性能，有时称为 *干扰性邻居* 问题。 更新和更改可以在租户间逐步推出，这会减少系统范围内中断的可能性。

**风险：** 成本效率较低，因为你不会在租户之间共享基础结构。 如果单个租户需要在基础结构上花费一定量，则100租户可能需要成本为100倍。 此外，日常维护 (如应用新配置或软件更新) 可能会非常耗时。 考虑自动执行操作过程，并考虑在你的环境中逐步应用更改。 还应考虑到整个场地的其他跨部署操作，如报表和分析。 同样，请确保计划在多个部署中查询和操作数据的方式。

### 完全多租户部署

在相反的极端情况下，可以考虑使用完全多租户部署，其中所有组件都是共享的。 你只需部署和维护一组基础结构，所有租户都使用它，如下图所示：

![Diagram showing three tenants, all using a single shared deployment.](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/fully-multitenant-deployments.png)

**优势：** 此模型很有吸引力，因为使用共享组件操作解决方案的成本更低。 即使你需要部署更高层或更多的资源，但总体部署成本通常低于一组单租户资源。 此外，如果用户或租户需要将其数据移到另一个逻辑租户，则无需在两个单独的部署之间迁移数据。

**带来**

- 请注意确保为每个租户分离数据，并且不会在租户之间泄漏数据。 你可能需要自行管理分片数据。 此外，您可能还需要考虑单个租户可对整个系统产生的影响。 例如，如果一个大型租户尝试执行繁重的查询或操作，它是否会影响其他租户？
- 如果这对你很重要，确定你如何 [跟踪 Azure 成本并将其与租户相关联](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/measure-consumption)。 使用单个部署可以简化维护，因为只需更新一组资源。 但这通常也是 riskier 的，因为任何更改都可能会影响整个客户群。
- 规模也是要考虑的因素。 当你有一组共享的基础结构时，更有可能达到 [Azure 资源缩放限制](https://docs.microsoft.com/zh-CN/azure/azure-resource-manager/management/azure-subscription-service-limits) 。 例如，如果你使用存储帐户作为你的解决方案的一部分，则当你的规模增加时，对该存储帐户的请求数可能会达到存储帐户可处理的限制。 若要避免达到资源配额限制，可以考虑部署资源的多个实例 (例如，) 多个 AKS 群集或存储帐户，也可以考虑在已部署到多个 Azure 订阅中的资源之间分配租户。
- 可能会限制单个部署的规模，而且这样做的成本可能会以非线性方式增加。 例如，如果您有一个共享数据库，当您在非常高的规模下运行时，您可能会耗尽其吞吐量，并且必须更进一步支付以增加吞吐量，以满足您的需求。

### 垂直分区部署

不一定会遇到这些规模的极端情况。 相反，可以考虑将租户垂直分区，步骤如下：

- 使用单租户和多租户部署的组合。 例如，你可能拥有多租户基础结构上的大部分客户数据和应用程序层，但你可以为需要更高性能或数据隔离的客户部署单租户基础结构。
- 在地理上部署解决方案的多个实例，并将每个租户固定到特定部署。 当你在不同地区拥有租户时，这种做法特别有效。

下面是一个示例，演示了某些租户的共享部署，以及另一个租户的部署：

![Diagram showing three tenants. Tenants A and B share a deployment. Tenant C has a dedicated deployment.](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/vertically-partitioned-deployments.png)

**优势：** 由于仍在共享基础结构，因此仍可获得具有共享多租户部署的一些成本优势。 你可以为某些客户部署成本更低的共享资源，就像尝试使用试用服务的用户一样。 你甚至可以将更高的费率计费为单租户部署，从而 recouping 你的成本。

**风险：** 你的基本代码可能需要设计为支持多租户和单租户部署。 如果打算允许在基础结构之间进行迁移，则需要考虑如何将客户从多租户部署迁移到其自己的单租户部署。 还需要清楚地了解哪一逻辑租户是哪组物理基础结构，以便可以将有关系统问题或升级的信息传达给相关客户。

### 横向分区部署

还可以考虑水平分区部署。 这意味着你有一些共享组件，同时还使用单租户部署来维护其他组件。 例如，你可以生成一个应用层，然后为每个租户部署单个数据库，如下图所示：

![Diagram showing three tenants, each using a dedicated database and a single, shared web server.](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/media/tenancy-models/horizontally-partitioned-deployments.png)

**优势：** 如果你已确定系统中的大多数负载是由于你可以为每个租户单独部署的特定组件引起的，则水平分区部署可帮助你缓解干扰邻居问题。 例如，您的数据库可能会吸收您的大部分系统负载，因为查询负载很高。 如果单个租户向你的解决方案发送大量请求，则数据库的性能可能会受到负面影响，但其他租户的数据库 (和共享组件，如应用层) 不受影响。

**风险：** 使用水平分区部署时，仍需要考虑自动部署和管理组件，尤其是单个租户使用的组件。

## 测试隔离模型

无论选择哪种隔离模型，都要确保测试解决方案以验证一个租户的数据不会意外泄露给另一个租户，并且任何干扰性的 [邻居](https://docs.microsoft.com/zh-cn/azure/architecture/antipatterns/noisy-neighbor/) 效果都是可接受的。 请考虑使用 [Azure 混乱 Studio](https://docs.microsoft.com/zh-CN/azure/chaos-studio/chaos-studio-overview) 特意引入用于模拟实际故障的故障，并验证解决方案的复原能力（即使组件不正常时）。

## 后续步骤

考虑 [租户的生命周期](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenant-lifecycle)。

------

## 建议的内容

- [多租户解决方案的体系结构注意事项 - Azure Architecture Center](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/overview)

  本文介绍了在规划多租户体系结构时需要考虑的注意事项。

- [多租户解决方案中的体系结构方法 - Azure Architecture Center](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/approaches/overview)

  本文介绍计划多租户体系结构时可以考虑的方法。

- [多租户解决方案中的租户生命周期注意事项 - Azure Architecture Center](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenant-lifecycle)

  本文介绍租户生命周期的不同阶段，以及每个阶段的注意事项。

- [多租户的相关资源 - Azure Architecture Center](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/related-resources)

  本文为多租户解决方案的架构师和开发人员提供了一组链接和资源。

显示更多

本文内容[定义租户](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#define-a-tenant)[如何决定使用哪个模型？](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#how-do-you-decide-which-model-to-use)[逻辑租户和物理租户](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#logical-and-physical-tenants)[租户隔离](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#tenant-isolation)[常见租户模型](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#common-tenancy-models)[测试隔离模型](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#test-your-isolation-model)[后续步骤](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models#next-steps)

[中文 (简体)](https://docs.microsoft.com/zh-cn/locale?target=https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models)



[多租户解决方案要考虑的租户模型 - Azure Architecture Center | Microsoft Docs](https://docs.microsoft.com/zh-cn/azure/architecture/guide/multitenant/considerations/tenancy-models)